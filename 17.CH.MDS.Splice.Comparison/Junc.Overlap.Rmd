
##Overlap between CH and MDS 

```{r}
junctions.bulk.mds <- read.table("/gpfs/commons/groups/landau_lab/SF3B1_splice_project/7.Permutation_junction_output/6.Comb_patients_2WT/5_read_threshold/MDS_P5_P6/logOR_within_cell_type_ONLY_CRYPTIC_3P_Junctions_with_threshold_info.txt")

junctions.bulk.ch <- read.table("/gpfs/commons/groups/landau_lab/SF3B1_splice_project/7.Permutation_junction_output/4.Comb_patients_merge_counts/CH_combined/logOR_within_cell_type_ONLY_CRYPTIC_3P_Junctions_with_threshold_info.txt")

all.cryptic.sites <- union(junctions.bulk.mds$intron_junction, junctions.bulk.ch$intron_junction)



length(all.cryptic.sites)
```




```{r}
junctions.bulk.mds
junctions.bulk.ch


length(junctions.bulk.ch[which(junctions.bulk.ch$dPSI > 0),]$intron_junction)

length(junctions.bulk.mds[which(junctions.bulk.mds$dPSI > 0),]$intron_junction)

length(intersect(junctions.bulk.mds[which(junctions.bulk.mds$dPSI > 0),]$intron_junction, junctions.bulk.ch[which(junctions.bulk.ch$dPSI > 0),]$intron_junction))


```



```{r}
#calculate p-value for three circle venn diagram 
## intersection

drawtest3<-function(N,m,a,b,c){
#N=7000 # total number of genes for selection
#m=3 # number of overlaps in all three sets
#a=200 # number of up-regulated genes in sample A
#b=250 # number of up-regulated genes in sample B
#c=300 # number of up-regualted genes in sample C

#create a dataframe to store frequency table
d<-data.frame(0:min(a,b,c),rep(0,min(a,b,c)+1))

for (i in 1:10000){
A=sample(1:N,size=a,replace=FALSE)
B=sample(1:N,size=b,replace=FALSE)
C=sample(1:N,size=c,replace=FALSE)
e<-table((C %in% A)&(C %in% B))["TRUE"]
# if there is no intersection, put 0 instead of NA
if(!complete.cases(e)){
e<-0
}
# add one to the counter for corresponding occurence
d[e+1,2]<-d[e+1,2]+1
}
colnames(d)<-c("Intersect","p-value")
# convert counts to ratios
d[,2]<-d[,2]/10000
# calculate p-value
p<-sum(d[(m+1):(min(a,b,c)+1),2])
#print(d)
return(p)
}


drawtest3()

library(gmp)

enrich_pvalue <- function(N, A, B, k)
{
    m <- A + k
    n <- B + k
    i <- k:min(m,n)

    as.numeric( sum(chooseZ(m,i)*chooseZ(N-m,n-i))/chooseZ(N,n) )
}
```



```{r fig.height=10, fig.width=10}
library(VennDiagram)
library(ggven)

MDS.junctions <- read.table("/gpfs/commons/groups/landau_lab/SF3B1_splice_project/7.Permutation_junction_output/6.Comb_patients_2WT/5_read_threshold/MDS_P5_P6/logOR_within_cell_type_ONLY_CRYPTIC_3P_Junctions_with_threshold_info.txt")

#MDS.junctions <- read.table("/gpfs/commons/groups/landau_lab/SF3B1_splice_project/7.Permutation_junction_output/4.Comb_patients_merge_counts/MDS_P5_P6/logOR_within_cell_type_ONLY_CRYPTIC_3P_Junctions_with_threshold_info.txt")

CH.junctions <- read.table("/gpfs/commons/groups/landau_lab/SF3B1_splice_project/7.Permutation_junction_output/4.Comb_patients_merge_counts/CH_combined/logOR_within_cell_type_ONLY_CRYPTIC_3P_Junctions_with_threshold_info.txt")


MDS.junction.list <- unique(paste(MDS.junctions$intron_junction))
CH.junction.list <- unique(paste(CH.junctions$intron_junction))

x <- list(MDS.cryptic = MDS.junction.list, CH.cryptic = CH.junction.list)


display_venn <- function(x, ...){
  library(VennDiagram)
  grid.newpage()
  venn_object <- venn.diagram(x, filename = NULL, ...)
  grid.draw(venn_object)
}

#"#3abeff" - blue color

pdf("/gpfs/commons/groups/landau_lab/SF3B1_splice_project/17.CH.MDS.Splice.Comparison/CH.MDS.bulk.cryptic.junc.overlap.pdf", width = 10, height =10 )
venn_object <- draw.pairwise.venn(length(MDS.junction.list),length(CH.junction.list), length(intersect(MDS.junction.list,CH.junction.list)) , c("MDS cryptic junctions","CH cryptic junctions"), fill = c("light blue", "white"), lty=c("dashed","dashed"), cex=1.5 ,cat.pos = c(0,0), cat.cex=2, label.col = c("black","red","black"))
grid.draw(venn_object)
grid.newpage()
dev.off()
```


```{r}
length(ch.heatmap.junction.list.full)
length(mds.heatmap.junction.list.full)

intersect(mds.heatmap.junction.list.full,ch.heatmap.junction.list.full )
```


```{r}
ch.heatmap.junction.list <- CH.junctions.dPSI.2.sig.5.read.thresh
mds.heatmap.junction.list <- MDS.junctions.dPSI.2.sig.5.read.thresh

pdf("/gpfs/commons/groups/landau_lab/SF3B1_splice_project/17.CH.MDS.Splice.Comparison/CH.MDS.per.ct.dPSI.2.sig.5.read.thresh.cryptic.junc.overlap.pdf", width = 10, height =10 )
venn_object <- draw.pairwise.venn(length(mds.heatmap.junction.list), length(ch.heatmap.junction.list), length(intersect(mds.heatmap.junction.list,ch.heatmap.junction.list)) , c("MDS cryptic junctions","CH cryptic junctions"), fill = c("light blue", "white"), lty=c("dashed","dashed"), cex=1.5 ,cat.pos = c(0,0), cat.cex=2, label.col = c("black","red","black"))
grid.draw(venn_object)
grid.newpage()
dev.off()
```

##Looking specifically at BAX (and then all shared junctions - do they correlate)


```{r}
ch.mut.psi.per.window <- ch.mut.psi.per.window.8
mds.mut.psi.per.window <- mds.mut.psi.per.window.8

shared.junctions <- intersect(rownames(ch.mut.psi.per.window), rownames(mds.mut.psi.per.window))

ch.mut.psi.per.window[shared.junctions,]
mds.mut.psi.per.window[shared.junctions,]
```

##Plot the PSI's for similar genes to see if they match

```{r}


junction <- "BAX:chr19:48960914:48961482:+"
junction <- "UROD:chr1:45012285:45012856:+"
junction <- "SEPT2:chr2:241335212:241335958:+"
junction <- "EIF4A2:chr3:186783639:186784428:+"
junction <- "METTL5:chr2:169812524:169815476:-"
junction <- "SLTM:chr15:58917020:58932355:-"
junction <- "METTL17:chr14:20990598:20992091:+"
junction <- "CASP8:chr2:201234112:201266460:+"
junction <- "ERGIC3:chr20:35556271:35556954:+"
junction <- "MED6:chr14:70593009:70593295:-"
junction <- "AUP1:chr2:74527121:74527247:-"



```

```{r}

df <- as.data.frame(matrix(ncol=2, nrow=ncol(ch.mut.psi.per.window)))
colnames(df) <- c("MDS.psi","CH.psi")

df$MDS.psi <- as.numeric(paste(mds.mut.psi.per.window[junction,]))
df$CH.psi <- as.numeric(paste(ch.mut.psi.per.window[junction,]))
df$bin.num <- rownames(df)
df

Color1 <- "blue"
Color2 <- "red"

m <- floor(min(df$MDS.psi))
df$MDS.psi <- df$MDS.psi - m


OldMax = max(df$CH.psi)
OldMin = min(df$CH.psi)
OldRange = (OldMax - OldMin)

NewMax = max(df$MDS.psi)
NewMin = min(df$MDS.psi)
NewRange = (NewMax - NewMin)


pdf(paste0("/gpfs/commons/groups/landau_lab/SF3B1_splice_project/17.CH.MDS.Splice.Comparison/MDS.CH.mut.psi.corr.8.bins.",junction,".pdf"), width = 12, height = 8)
ggplot(df, mapping = aes(x, y, group =1)) + 
  #geom_line(aes(x = bin.num, y = MDS.psi), color="blue") +
  #geom_point(aes(x = bin.num, y = MDS.psi),color="blue") +
  geom_bar(data = data.frame(x = df$bin.num, y = df$MDS.psi), stat = 'identity', fill="blue", alpha=0.3) +
  stat_smooth(aes(x = bin.num, y = MDS.psi), color="blue", method = "loess", formula = y ~ x, se = F, span=1) +
  #geom_line(aes(x = bin.num, y=(((CH.psi - OldMin) * NewRange) / OldRange) + NewMin),color="red") +
  #geom_point(aes(x = bin.num, y=(((CH.psi - OldMin) * NewRange) / OldRange) + NewMin),color="red") +
  geom_bar(data = data.frame(x = df$bin.num, y=(((df$CH.psi - OldMin) * NewRange) / OldRange) + NewMin), stat = 'identity', fill = 'red', alpha=0.3) +
  stat_smooth(aes(x = bin.num, y=(((CH.psi - OldMin) * NewRange) / OldRange) + NewMin), color="red", method = "loess", formula = y ~ x, se = F, span=1) +
  scale_y_continuous(
    name = "MDS.mut.psi",
    breaks=seq(0,50),
    labels=(seq(0,50) + m),
    sec.axis = sec_axis(~(((.-NewMin)*OldRange)/NewRange) + OldMin , name="CH.mut.psi")) +
  theme_classic() +
  labs(x="bin",
       title = paste0("MDS vs CH mut.psi for cryptic junction - ", junction),
       subtitle = paste0("Spearman Correlation : ", round(cor(df$MDS.psi, df$CH.psi, method = c("spearman") ), 4))) +
  theme(plot.title = element_text(vjust = 2.5,hjust = 0.5, size = 13), 
        axis.title.y = element_text(color=Color1  , size=12), 
        axis.title.y.right = element_text(color = Color2, size=12),
        plot.subtitle=element_text(size=12, hjust=0.5, face="italic", color="red")) 

dev.off()

```




```{r}
ch.annotation_row
```


##Any (significant in at least 1 cell type, with dPSI >= 2)
```{r}
ch.annotation_row <- ch.annotation_row[which(ch.annotation_row$sum > 0),]

mds.annotation_row <- mds.annotation_row.8[which(mds.annotation_row.8 $sum > 0),]

ch.annotation_row
ch.mut.psi.per.window
mds.annotation_row
mds.mut.psi.per.window

shared.junctions <- intersect(rownames(ch.annotation_row), rownames(mds.annotation_row))
shared.junctions


ch.mut.psi.per.window
mds.mut.psi.per.window

correlations.values <- as.data.frame(matrix(ncol=3,nrow=length(shared.junctions)))
colnames(correlations.values) <- c("mut.psi.correlation", "MDS.psi.range","CH.psi.range")
rownames(correlations.values) <- shared.junctions

for (junction in shared.junctions){
  correlations.values[junction,]$mut.psi.correlation <- cor(as.numeric(ch.mut.psi.per.window[junction,]), as.numeric(mds.mut.psi.per.window[junction,]), method = "spearman")
  correlations.values[junction,]$MDS.psi.range <- mds.annotation_row[junction,]$psi.range
  correlations.values[junction,]$CH.psi.range <- ch.annotation_row[junction,]$psi.range
}

```


```{r}
library(ggrepel)
correlations.values$group <- "Shared"

correlations.values$gene <- unlist(lapply(strsplit(rownames(correlations.values),split= ":"), "[",1))
correlations.values

ggplot(correlations.values, aes(x=mut.psi.correlation, y=group)) + geom_boxplot() + geom_point() + theme_classic() + geom_label_repel(aes(label = ifelse(mut.psi.correlation >=0.5 , gene, "")),
                  box.padding   = 0.35, point.padding = 0.5, segment.color = 'grey50', color ="blue") + xlim(-1,1)


ifelse(PTS>24,as.character(Name),'')
```

##Take the genes highlighted in the heatmap and map the correlations for those then go ahead and highlight BAX

```{r}
ch.junc <- rownames(ch.annotation_row[which(ch.annotation_row$psi.range >=2),])
mds.junc <- rownames(mds.annotation_row[which(mds.annotation_row$psi.range >=2),])

both.variable.junc <- intersect(ch.junc, mds.junc)

heatmap.junc <- intersect(ch.junc, rownames(mds.annotation_row))

```




```{r}
mds.annotation_row[rownames(correlations.values),]

correlations.values$NMD.verdict <- mds.annotation_row[rownames(correlations.values),]$NMD.junction.verdict

#table(correlations.values[which(correlations.values$NMD.verdict == "NMD"),]$corr.class)
#table(correlations.values[which(correlations.values$NMD.verdict == "not NMD"),]$corr.class)
```


```{r}
correlations.values
```


```{r fig.height=10, fig.width=7}
library(ggplot2)
#theme_set(theme_bw())


correlations.values$corr.class <- NA
correlations.values[which(correlations.values$mut.psi.correlation >=0.5),]$corr.class <- "very positive"
correlations.values[which(correlations.values$mut.psi.correlation <= -0.5),]$corr.class <- "very negative"
correlations.values[which(correlations.values$mut.psi.correlation < 0.5 & correlations.values$mut.psi.correlation >0),]$corr.class <- "positive"
correlations.values[which(correlations.values$mut.psi.correlation > -0.5 & correlations.values$mut.psi.correlation < 0),]$corr.class <- "negative"

df <- correlations.values %>% arrange(mut.psi.correlation)
df <- correlations.values[both.variable.junc,] %>% arrange(mut.psi.correlation)
df <- correlations.values[heatmap.junc,] %>% arrange(mut.psi.correlation)
df

df <- correlations.values[which(correlations.values$MDS.psi.range >=1.5 & correlations.values$CH.psi.range >=1.5),] %>% arrange(mut.psi.correlation)
# Plot

df[which(df$gene == "SERBP1"),]$gene <- c("SERBP1.1","SERBP1.2")
df$gene <- factor(df$gene, levels = df$gene)
df$corr.class <- factor(df$corr.class, levels =c("very negative","negative","positive","very positive"))

pdf("/gpfs/commons/groups/landau_lab/SF3B1_splice_project/17.CH.MDS.Splice.Comparison/CH.MDS.Mut.PSI.Corr.Diverging.Dot.Plot.pdf", width = 10, height =15 )
ggplot(df, aes(x=gene, y=mut.psi.correlation)) + 
  geom_point(stat='identity', aes(col=corr.class), size=10)  +
  scale_color_manual(name="Correlation Class", 
                     #labels = c("Above Average", "Below Average"), 
                     values = c("dark blue","light blue", "pink", "red")) +
  ylim(-1, 1) + coord_flip() + theme_bw()
dev.off()
```


#Distribution of correlation values - where does the median sit
```{r}
ggplot(correlations.values, aes(x=mut.psi.correlation)) + geom_density(color="darkblue", fill="lightblue") + geom_vline(aes(xintercept=mean(mut.psi.correlation)),color="blue", linetype="dashed", size=1) + theme_classic()
```


##Vairbale in both
```{r}

df.sub <- correlations.values[which(correlations.values$MDS.psi.range >=2 & correlations.values$CH.psi.range >=2),]
ggplot(df.sub, aes(x=mut.psi.correlation)) + geom_density(color="darkblue", fill="lightblue") + geom_vline(aes(xintercept=mean(mut.psi.correlation)),color="blue", linetype="dashed", size=1) + theme_classic()
```


```{r}
correlations.values[which(correlations.values$mut.psi.correlation >=0.5),]

correlations.values[which(correlations.values$mut.psi.correlation <=-0.5),]
```



