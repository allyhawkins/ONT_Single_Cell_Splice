##Load packages
```{r}
library(Seurat)
library(tidyverse)
library(gridExtra)
library(grid)
library(ggplot2)
library(lattice)
```

##Load Seurat object and add RNA exp and ADT exp to the metadata for the antibodies/genes we want to focus in on 
```{r}
#Load re-normalized Seurat object 
load("/Users/Celine/Documents/Landau/CITE-seq/2_MDS_patients/mds.p4.p5.p6.CITE.Analysis/mds.samples.integrated.celltypes.subsetted.Rdata")
Idents(mds.samples.integrated) <- "Cell.Assignment_adj"
```

Here we only are interested in antibodies in the CITE-seq data that had good antibody capture. As a cutoff, we filtered for those antibodies that had at least one cell type > 2 SD in the DSB analysis. We added CD49f to this list as well.
```{r}
#Grab the RNA expression data and add it to the metadata
#All genes
#genes <- c("CD38","ITGA2B","PTPRC","CD36","CD69","CD9","CD14","CD37","CD47","CD52","CD84","CD79B","CD81","TFRC","ITGA6","CD7","CD99","CXCR4","FLT3")
#Only the subsetted genes 
genes <- c("CD99", "CD47", "CD84", "CD38", "PTPRC", "CD36", "TFRC", "ITGA6")
DefaultAssay(mds.samples.integrated) <- "RNA"
RNA_expression <- FetchData(mds.samples.integrated, vars=genes, slot = "data")
mds.samples.integrated <- AddMetaData(mds.samples.integrated, RNA_expression)
print(colnames(mds.samples.integrated@meta.data))

#Grab the ADT expression data and add it to the metadata
#All antibodies
#antibodies <- unique(rownames(mds.samples.integrated@assays$ADT@counts))
#Only the subsetted antibodies
antibodies <- c("ADT-CD99","ADT-CD47","ADT-CD84","ADT-CD38","ADT-CD45","ADT-CD36","ADT-CD71","ADT-CD49f")
DefaultAssay(mds.samples.integrated) <- "ADT"
RNA_expression <- FetchData(mds.samples.integrated, vars=antibodies, slot = "data")
mds.samples.integrated <- AddMetaData(mds.samples.integrated, RNA_expression)
print(colnames(mds.samples.integrated@meta.data))
```

##Line up gene names with protein names, then make correlation and ridgeplots
These corrplots are to show the correlation between CITEseq v. RNAseq data, to evaluate the quality of the CITEseq data
```{r}
#Remove the outlier in CD45
mds.samples.integrated@meta.data
mds.samples.integrated@meta.data[which(mds.samples.integrated@meta.data$ADT.CD45 > 5),]
toRemove <- "GTGCAGCCACTCACTC_2"
mds.samples.integrated <- mds.samples.integrated[,!colnames(mds.samples.integrated) %in% toRemove]

#Convert ADT names to genes in scRNA
library(readxl)
antibodies <- read_xlsx("/Users/Celine/Documents/Landau/CITE-seq/RNAseq MDS/2020_08_TotalSeqA_ND.xlsx")
ensemblsIDS <- antibodies$`Ensembl Gene Id`
library(org.Hs.eg.db) # remember to install it if you don't have it already
symbols <- mapIds(org.Hs.eg.db, keys = ensemblsIDS, keytype = "ENSEMBL", column="SYMBOL")
symbols <- lapply(symbols, function(x){
  if (is.null(x)){
    x <- NA
  }
  return(x)
})
symbols_df <- data.frame("ensembl" = names(symbols), "genes" = unname(unlist(symbols)))
symbols_df[is.na(symbols_df$ensembl),]$genes <- antibodies$Description[is.na(symbols_df$ensembl)]
symbols_df <- symbols_df[!is.na(symbols_df$genes),]
symbols_df <- symbols_df[!is.na(symbols_df$ensembl),]
lookup <- merge(antibodies, symbols_df, by.x = "Ensembl Gene Id", by.y = "ensembl")[,c("Description", "genes")]
DefaultAssay(mds.samples.integrated) <- "RNA"
Idents(mds.samples.integrated) <- "Cell.Assignment_adj"
#adt_names <- rownames(mds.samples.integrated@assays$ADT@counts)
adt_names <- c("ADT-CD99","ADT-CD47","ADT-CD84","ADT-CD38","ADT-CD45","ADT-CD36","ADT-CD71","ADT-CD49f","ADT-CD7")
plots <- list()
plots_edit <- list()
Ridge_and_corr_plots <-  list()

```

```{r}
for (i in adt_names){
  print(i)
  gene_name <- gsub("ADT-", "", i)
  print(gene_name)
  if (gene_name %in% rownames(mds.samples.integrated)){
    cells1 <- names(mds.samples.integrated@assays$ADT@data[i,][mds.samples.integrated@assays$ADT@data[i,] > 0])
    cells2 <- names(mds.samples.integrated@assays$RNA@data[gene_name,][mds.samples.integrated@assays$RNA@data[gene_name,] > 0])
    cells_to_use <- intersect(cells1,cells2)
    plots[[gene_name]] <- FeatureScatter(mds.samples.integrated, feature1 = i, feature2 = gene_name)
    plots_edit[[gene_name]] <- FeatureScatter(mds.samples.integrated, feature1 = i, feature2 = gene_name, cells = cells_to_use)
    Ridge_Plot <- RidgePlot(mds.samples.integrated, features = i ,sort=T)
    #Ridge_and_corr_plots[[i]] <- cowplot::plot_grid(Ridge_Plot, plots_edit[[gene_name]], nrow = 1)
    Ridge_and_corr_plots[[i]] <- cowplot::plot_grid(Ridge_Plot, plots[[gene_name]], nrow = 1)
    #path <- paste0("/gpfs/commons/home/pchamely/SF3B1_ont_splice_project/2_MDS_patients/mds.p4.p5.p6.CITE.Analysis/CITE.pdfs/Ridge_Corr_Plots/post_cleanup/MDSP.5.6.CITE_",i,".pdf")
    path <- paste0("/Users/Celine/Documents/Landau/CITE-seq/2_MDS_patients/mds.p4.p5.p6.CITE.Analysis/CITE.pdfs/Ridge_Corr_Plots/pre_cleanup/MDSP.5.6.CITE_",i,".pdf")
    pdf(path, width = 15, height = 10)
    cowplot::plot_grid(Ridge_Plot, plots_edit[[gene_name]], nrow = 1)
    dev.off()
  } else{
    gene_name <- paste(unique(lookup %>% filter(Description == gene_name) %>% pull(genes)))
    print(gene_name)
    if (gene_name %in% rownames(mds.samples.integrated)){
      cells1 <- names(mds.samples.integrated@assays$ADT@data[i,][mds.samples.integrated@assays$ADT@data[i,] > 0])
      cells2 <- names(mds.samples.integrated@assays$RNA@data[gene_name,][mds.samples.integrated@assays$RNA@data[gene_name,] > 0])
      cells_to_use <- intersect(cells1,cells2)
      plots[[gene_name]] <- FeatureScatter(mds.samples.integrated, feature1 = i, feature2 = gene_name)
      plots_edit[[gene_name]] <- FeatureScatter(mds.samples.integrated, feature1 = i, feature2 = gene_name, cells = cells_to_use)
      Ridge_Plot <- RidgePlot(mds.samples.integrated, features = i ,sort=T)
      #Ridge_and_corr_plots[[i]] <- cowplot::plot_grid(Ridge_Plot, plots_edit[[gene_name]], nrow = 1)
      Ridge_and_corr_plots[[i]] <- cowplot::plot_grid(Ridge_Plot, plots[[gene_name]], nrow = 1)
      #path <- paste0("/gpfs/commons/home/pchamely/SF3B1_ont_splice_project/2_MDS_patients/mds.p4.p5.p6.CITE.Analysis/CITE.pdfs/Ridge_Corr_Plots/post_cleanup/MDSP.5.6.CITE_",i,".pdf")
      path <- paste0("/Users/Celine/Documents/Landau/CITE-seq/2_MDS_patients/mds.p4.p5.p6.CITE.Analysis/CITE.pdfs/Ridge_Corr_Plots/pre_cleanup/MDSP.5.6.CITE_",i,".pdf")
      pdf(path, width = 15, height = 10)
      Ridge_and_corr_plots[[i]]
      dev.off()
    }
  }
}
names(plots_edit)
Ridge_and_corr_plots$`ADT-CD38`
names(Ridge_and_corr_plots)
require(lattice)
for (i in names(Ridge_and_corr_plots)){
  path <- paste0("/Users/Celine/Documents/Landau/CITE-seq/2_MDS_patients/mds.p4.p5.p6.CITE.Analysis/CITE.pdfs/Ridge_Corr_Plots/pre_cleanup/MDSP.5.6.CITE_",i,".pdf")
  pdf(path, width = 15, height = 8)
  print(Ridge_and_corr_plots[[i]])
  dev.off()
}
```

```{r fig.width=10, fig.height=10}
do.call(grid.arrange, c(plots, ncol=3))
do.call(grid.arrange, c(plots_edit, ncol=3)) #after removing the RNA dropouts 
names(plots_edit)
```
