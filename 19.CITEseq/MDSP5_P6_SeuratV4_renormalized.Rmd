This script takes the mds.samples.integrated object, subsets it into a smaller object to include only samples MDS_P5_1, MDS_P5_2, and MDS_P6, and only six celltypes that will be used in the final analysis. Then it performs the CLR normalization of ADT data and WNN analysis on the subsetted object.
*https://satijalab.org/seurat/articles/weighted_nearest_neighbor_analysis.html
*https://satijalab.org/seurat/articles/sctransform_vignette.html
*https://satijalab.org/seurat/articles/multimodal_vignette.html

##Load packages
```{r}
library(Seurat) #Run on Seurat V4, which is not supported here
library(sctransform)
library(tidyverse)

install.packages("Seurat")
```

```{r}
#Load in the Seurat object here
load("/gpfs/commons/groups/landau_lab/SF3B1_splice_project/4.Integrated_seurat_objs/mds.sample.integrated.p4.5.6.in.progress_2_withPseudotime.RData")
seurat@meta.data
```

##First subset only P5_1, P5_2, P6
##Second subset by celltype
```{r}
seurat@meta.data
temp_object <- subset(seurat, subset = orig.ident == "MDS_P5_1" | orig.ident == "MDS_P5_2" | orig.ident == "MDS_P6")
temp_object <- subset(patient_object, subset = Cell.Assignment_adj == "HSPC"|Cell.Assignment_adj == "IMP"|Cell.Assignment_adj == "NP"|Cell.Assignment_adj == "MkP"|Cell.Assignment_adj == "MEP"|Cell.Assignment_adj == "EP")
str(temp_object@assays$ADT@data)
```

##SCTransform and integrate the data 
```{r}
mds.samples.integrated <- temp_object
mds.samples.integrated@assays$ADT
mds.samples.integrated<- SCTransform(mds.samples.integrated, 
                              verbose = TRUE, 
                              vars.to.regress = c("nCount_RNA", "percent.mito","S.Score", "G2M.Score"),
                              return.only.var.genes = FALSE, 
                              variable.features.rv.th = 0) 
str(mds.samples.integrated@assays$ADT@data)
```

##Following the Seurat vignette
```{r}
DefaultAssay(mds.samples.integrated) <- "integrated"
mds.samples.integrated <- RunPCA(mds.samples.integrated, verbose = TRUE)
#Still need to run
#mds.samples.integrated  <- JackStraw(mds.samples.integrated, dims = 30)
#mds.samples.integrated  <- ScoreJackStraw(mds.samples.integrated , dims = 1:30)
#mds.samples.integrated@reductions$pca@jackstraw$overall.p.values
```

#Normalize data
```{r}
DefaultAssay(mds.samples.integrated) <- 'ADT'
VariableFeatures(mds.samples.integrated) <- rownames(mds.samples.integrated[["ADT"]]) 
#Here we normalize after we have subsetted the 6 celltypes we will include in our final analysis
mds.samples.integrated <- NormalizeData(mds.samples.integrated, normalization.method = 'CLR', margin = 2) %>% ScaleData() %>% RunPCA(reduction.name = 'apca')
```

##Figure out which PCs to include
```{r}
DefaultAssay(mds.samples.integrated) <- "integrated"
mds.samples.integrated  <- JackStraw(mds.samples.integrated, dims = 30)
mds.samples.integrated  <- ScoreJackStraw(mds.samples.integrated , dims = 1:30)
mds.samples.integrated@reductions$pca@jackstraw$overall.p.values
JackStrawPlot(mds.samples.integrated, dims = 1:30)
ElbowPlot(mds.samples.integrated)

#Not supported for anything other than pca reduction
#DefaultAssay(mds.samples.integrated) <- "ADT"
#mds.samples.integrated  <- JackStraw(mds.samples.integrated, reduction = "apca", dims = 1:20)
#mds.samples.integrated  <- ScoreJackStraw(mds.samples.integrated , dims = 1:30)
#mds.samples.integrated@reductions$pca@jackstraw$overall.p.values

colnames(mds.samples.integrated@reductions$pca@cell.embeddings)
colnames(mds.samples.integrated@reductions$apca@cell.embeddings)
```

```{r}
mds.samples.integrated <- FindMultiModalNeighbors(
  mds.samples.integrated, reduction.list = list("pca", "apca"), 
  dims.list = list(1:9, 1:20), modality.weight.name = "RNA.weight"
)
```

```{r}
mds.samples.integrated <- RunUMAP(mds.samples.integrated, nn.name = "weighted.nn", reduction.name = "wnn.umap", reduction.key = "wnnUMAP_")
mds.samples.integrated <- FindClusters(mds.samples.integrated, graph.name = "wsnn", algorithm = 3, resolution = 2, verbose = FALSE) 
mds.samples.integrated@reductions
```


```{r fig.height=3, fig.width=3}
DimPlot(mds.samples.integrated, reduction = 'wnn.umap', label = TRUE, repel = TRUE, label.size = 2.5) + NoLegend()

pdf('/Users/Celine/Documents/Landau/CITE-seq/MDS_P4.5.6_WNN.pdf', width = 10, height = 10) 
DimPlot(mds.samples.integrated, reduction = 'wnn.umap', group.by = 'Cell.Assignment_adj', label = TRUE, repel = TRUE, label.size = 5)
dev.off()

DimPlot(mds.samples.integrated, reduction = 'wnn.umap', group.by = 'orig.ident', label = TRUE, repel = TRUE, label.size = 2.5)
DimPlot(mds.samples.integrated, reduction = 'wnn.umap', group.by = 'Cell.Assignment_adj', label = TRUE, repel = TRUE, label.size = 2.5)
unique(mds.samples.integrated@meta.data$Cell.Assignment_adj)

#Save the normalized Seurat object 
save(mds.samples.integrated, file = "/Users/Celine/Documents/Landau/CITE-seq/2_MDS_patients/mds.p4.p5.p6.CITE.Analysis/mds.samples.integrated.celltypes.subsetted.Rdata") #Write new path here

```

##Highlight each cluster in a DimPlot
```{r}
plots_per_cluster <- list()
resolution <- "wsnn_res.2"
Idents(mds.samples.integrated) <- resolution
cluster_ids <-c(0: (length(unique(paste(mds.samples.integrated@meta.data[,resolution])))-1) )
#cluster_ids
##Getting the Seurat palette (change Idents to suite)
require(scales)
# Create vector with levels of object@ident
identities <- levels(mds.samples.integrated@active.ident)
# Create vector of default ggplot2 colors
my_color_palette <- hue_pal()(length(identities))

for (i in 1:length(cluster_ids)){
  plots_per_cluster[[i]] <- DimPlot(mds.samples.integrated , reduction = "wnn.umap", label = TRUE, cells.highlight = WhichCells(mds.samples.integrated, idents = c(cluster_ids[i])) , sizes.highlight= 0.5) + scale_color_manual(labels = c("Unselected", cluster_ids[i]), values = c("grey", my_color_palette[i]))
}

#Idents(mds.samples.integrated) <- "seurat_clusters"

length(plots_per_cluster)
plots_per_cluster
```


##Highlight each celltype in a DimPlot
```{r fig.height=6, fig.width=6}
library(ggplot2)
plots_CA <- list()
Idents(mds.samples.integrated) <- "Cell.Assignment.Adj"
#Idents(mds.samples.integrated)[1:5]
celltype_list <- paste(unique(mds.samples.integrated@meta.data$Cell.Assignment_adj))
celltype_list
require(scales)
# Create vector with levels of object@ident
identities <- levels(mds.samples.integrated@active.ident)
my_color_palette <- hue_pal()(length(identities))
for (i in 1:length(celltype_list)){
  plots_CA[[i]] <- DimPlot(mds.samples.integrated , reduction = "wnn.umap", label = TRUE, cells.highlight = WhichCells(mds.samples.integrated, idents = c(celltype_list[i])) , sizes.highlight= 0.5) + scale_color_manual(labels = c("Unselected", celltype_list[i]), values = c("grey", my_color_palette[i]))
}
plots_CA

```

##Check to see if there are any NAs in the Cell.Assignment_adjcolumn of the metadata
```{r}
mds.samples.integrated@meta.data[which(is.na(mds.samples.integrated@meta.data$Cell.Assignment_adj)),]
```

```{r}
rownames(mds.samples.integrated@assays$ADT@counts)
FeaturePlot(mds.samples.integrated, features = c("ADT-CD36","ADT-CD14","ADT-CD45RA"))
```
#Save the MDS object which used the WNN method for clustering
```{r}
save(mds.samples.integrated, version=2, file="/Users/Celine/Documents/Landau/CITE-seq/mds.samples.integrated.p4.p5.p6.WNN.Rdata") #Change path here
```
