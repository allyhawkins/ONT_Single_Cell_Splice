##-------------------------------CITE-SEQ HEAT MAP SCRIPT----------------------------------------
This script walks through how to make two versions of the heatmap:
*Downsampling 1x and LMM (pval)
*Iterative downsampling 1000x and permutation test (pval)
This script also includes:
*Boxplots comparing MUT v WT, split up by patient id, for ADT and RNA
*ADT v. RNA corrplots at the cluster level (clustered by celltype)

##Load packages and functions
```{r}
library(Seurat)
library(tidyverse)
library(matrixStats)
```

Load the Find_Markers_med function before. This is a modified Find_Markers function, except that it uses the median ADT exp instead of the mean. 
/gpfs/commons/groups/landau_lab/SF3B1_splice_project/19.CITEseq/FindMarkers_med_function/

##Load Seurat object and add RNA exp and ADT exp to the metadata for the antibodies/genes we want to focus in on 
```{r}
#Load re-normalized Seurat object 
load("/Users/Celine/Documents/Landau/CITE-seq/2_MDS_patients/mds.p4.p5.p6.CITE.Analysis/mds.samples.integrated.celltypes.subsetted.Rdata")
Idents(mds.samples.integrated) <- "Cell.Assignment_adj"
```

Here we only are interested in antibodies in the CITE-seq data that had good antibody capture. As a cutoff, we filtered for those antibodies that had at least one cell type > 2 SD in the DSB analysis. We added CD49f to this list as well.
```{r}
#Grab the RNA expression data and add it to the metadata
#All genes
#genes <- c("CD38","ITGA2B","PTPRC","CD36","CD69","CD9","CD14","CD37","CD47","CD52","CD84","CD79B","CD81","TFRC","ITGA6","CD7","CD99","CXCR4","FLT3")
#Only the subsetted genes 
genes <- c("CD99", "CD47", "CD84", "CD38", "PTPRC", "CD36", "TFRC", "ITGA6")
DefaultAssay(mds.samples.integrated) <- "RNA"
RNA_expression <- FetchData(mds.samples.integrated, vars=genes, slot = "data")
mds.samples.integrated <- AddMetaData(mds.samples.integrated, RNA_expression)
print(colnames(mds.samples.integrated@meta.data))

#Grab the ADT expression data and add it to the metadata
#All antibodies
#antibodies <- unique(rownames(mds.samples.integrated@assays$ADT@counts))
#Only the subsetted antibodies
antibodies <- c("ADT-CD99","ADT-CD47","ADT-CD84","ADT-CD38","ADT-CD45","ADT-CD36","ADT-CD71","ADT-CD49f")
DefaultAssay(mds.samples.integrated) <- "ADT"
RNA_expression <- FetchData(mds.samples.integrated, vars=antibodies, slot = "data")
mds.samples.integrated <- AddMetaData(mds.samples.integrated, RNA_expression)
print(colnames(mds.samples.integrated@meta.data))
```

##-----------------------PART 1: Prepare for heatmap by making DiffExp, RNA, and ADT tables------------------------
##Downsample to the lowest number of MUT cells or WT cells, such that each patient contributes the same number of MUT cells and same number of WT cells
```{r}
seurat <- mds.samples.integrated
patient_id <- "orig.ident"
geno_col <- "Genotype_2UMI"
seurat@meta.data$cell_name <- rownames(seurat@meta.data) 
  min_mut <- min(table(seurat@meta.data[,patient_id], seurat@meta.data[,geno_col])[,"MUT"])
  min_wt <- min(table(seurat@meta.data[,patient_id], seurat@meta.data[,geno_col])[,"WT"])
  mut_cells <- seurat@meta.data %>% dplyr::select (c(patient_id, geno_col, "cell_name")) %>% filter(!!as.symbol(geno_col) == "MUT") %>% group_by(!!as.symbol(patient_id)) %>% sample_n(min_mut) %>% pull(cell_name)
  wt_cells <- seurat@meta.data %>% dplyr::select (c(patient_id, geno_col, "cell_name")) %>% filter(!!as.symbol(geno_col) == "WT") %>% group_by(!!as.symbol(patient_id)) %>% sample_n(min_wt) %>% pull(cell_name)
  seurat <- subset(seurat, cells = c(mut_cells, wt_cells))
  
downsampled_mut_wt <- seurat
save(downsampled_mut_wt, file="/Users/Celine/Documents/Landau/CITE-seq/2_MDS_patients/mds.p4.p5.p6.CITE.Analysis/downsamped_mut_wt_v3.Rdata") #write new path here

#Check how many cells per celltype and genotype there are in the downsampled object
print(table(downsampled_mut_wt$Cell.Assignment_adj))
print(table(downsampled_mut_wt$Genotype_2UMI))
```

##Make DiffExp and RNA tables
```{r}
#Subset by celltype and apply Find_Markers() function to calculate the med_logFC
Idents(downsampled_mut_wt) <- 'Genotype_2UMI'
downsampled_obj <- downsampled_mut_wt
per_elem_de.list <- list()   
celltypes <- list("NP", "IMP", "HSPC", "MkP", "MEP", "EP")
for (elem in celltypes){
if(nrow(downsampled_obj@meta.data[which(downsampled_obj@meta.data$Cell.Assignment_adj == elem & (downsampled_obj@meta.data$Genotype_2UMI == "MUT" | downsampled_obj@meta.data$Genotype_2UMI == "WT") ),]) > 0){
        obj_subset <- subset(downsampled_obj, subset = (Cell.Assignment_adj == elem) & (Genotype_2UMI == "MUT" | Genotype_2UMI == "WT") )
        if (nrow(obj_subset@meta.data[which(obj_subset$Genotype_2UMI == "WT"),]) > 3 & nrow(obj_subset@meta.data[which(obj_subset$Genotype_2UMI == "MUT"),]) > 3){
          Idents(obj_subset) <- "Genotype_2UMI"
          per_elem_de.list[[elem]] <- FindMarkers_med(obj_subset, ident.1 = "MUT", ident.2 = "WT", min.pct = 0.1, logfc.threshold = 0, assay = 'ADT') 
          ##Adjusting for FDR instead of Bonferroni correction
          per_elem_de.list[[elem]]$q_val <- p.adjust(per_elem_de.list[[elem]]$p_val , method="fdr")
          
        } else{
          print("too few genotyped cells")
          per_elem_de.list[[elem]] <- "too few genotyped cells"
        }
      } else {
        print("too few cells in general")
        per_elem_de.list[[elem]] <- "too few cells in general"
      }
    }
DE_tables <- per_elem_de.list
```

##Fill in the ADT logFC and pval tables comparing MUT/WT using the downsampled DE_tables
```{r}
#Select antibodies and cell types to include
#Antibodies that have at least 1 cell type for which > 2 DSB normalization + CD49f
antibodies<- list("ADT-CD99","ADT-CD47","ADT-CD84","ADT-CD38","ADT-CD45","ADT-CD36","ADT-CD71","ADT-CD49f")
celltypes <- list("NP", "IMP", "HSPC", "MkP", "MEP", "EP")

ct_LogFC_tables <- as.data.frame(matrix(ncol=length(celltypes), nrow=length(antibodies)))
ct_p_val_tables<- as.data.frame(matrix(ncol=length(celltypes), nrow=length(antibodies)))
rownames(ct_LogFC_tables) <- antibodies
colnames(ct_LogFC_tables) <- celltypes
rownames(ct_p_val_tables) <- antibodies
colnames(ct_p_val_tables) <- celltypes 

for (ct in celltypes){
  print("creating logFC table")
  ct_LogFC_tables[,ct] <-
  DE_tables[[ct]][rownames(ct_LogFC_tables),"med_logFC"] 
  print("creating p val table")
  ct_p_val_tables[,ct] <-
  DE_tables[[ct]][rownames(ct_p_val_tables),"p_val"]
}

print(ct_LogFC_tables)
print(ct_p_val_tables)
```


```{r}
#Make a dataframe for RNA exp using the original Seurat object, not the downsampled
genes <- c("CD99", "CD47", "CD84", "CD38", "PTPRC", "CD36", "TFRC", "ITGA6")
df <- mds.samples.integrated@meta.data %>% group_by(Cell.Assignment_adj) %>% summarize(across(genes, ~ mean(.x, na.rm = TRUE)))
df1 <- as.data.frame(t(as.matrix(df)))
df1 <- df1[-1, ]
colnames(df1) <-  c("HSPC","IMP","NP","MkP","MEP","EP")
rna_exp_matrix <- df1
rna_exp_matrix <- rna_exp_matrix[c("NP", "IMP", "HSPC", "MkP", "MEP", "EP")] #reorder celltypes
```


```{r}
#Create a parallel dataframe for ADT exp using the original Seurat object, not the downsampled
antibodies <- c("ADT.CD99","ADT.CD47","ADT.CD84","ADT.CD38","ADT.CD45","ADT.CD36","ADT.CD71","ADT.CD49f")
df <- mds.samples.integrated@meta.data %>% group_by(Cell.Assignment_adj) %>% summarize(across(antibodies, ~ mean(.x, na.rm = TRUE)))
df2 <- as.data.frame(t(as.matrix(df)))
df2 <- df2[-1, ]
colnames(df2) <- c("HSPC","IMP","NP","MkP","MEP","EP")
prot_exp_matrix <- df2
prot_exp_matrix <- prot_exp_matrix[c("NP", "IMP", "HSPC", "MkP", "MEP", "EP")] #reorder celltypes
```

##-----------------------PART 2: LMM to correct for non-independence in data------------------------
#Run LMM with response = ADT expression, and orig.ident and Genotype_2UMI as the random effect terms
```{r}
##Subset metadata by celltype and create a list separated by celltype
Idents(mds.samples.integrated) <- 'Cell.Assignment_adj'
HSPC <- subset(mds.samples.integrated@meta.data, subset = Cell.Assignment_adj =="HSPC")
IMP <- subset(mds.samples.integrated@meta.data, subset = Cell.Assignment_adj =="IMP")
NP <- subset(mds.samples.integrated@meta.data, subset = Cell.Assignment_adj =="NP")
MkP <- subset(mds.samples.integrated@meta.data, subset = Cell.Assignment_adj =="MkP")
MEP <- subset(mds.samples.integrated@meta.data, subset = Cell.Assignment_adj =="MEP")
EP <- subset(mds.samples.integrated@meta.data, subset = Cell.Assignment_adj =="EP")
celltype <- list(NP, IMP, HSPC, MkP, MEP, EP)
names(celltype) <- c("NP","IMP","HSPC","MkP","MEP","EP")

#Loop over antibodies and calculate LMM p val per cell type and antibody
pval <- list()
df <- list()
antibody <- c("ADT.CD99","ADT.CD47","ADT.CD84","ADT.CD38","ADT.CD45","ADT.CD36","ADT.CD71","ADT.CD49f")
for(j in antibody){
  for(i in 1:length(celltype)){
    mydf4<-celltype[[i]][which(celltype[[i]]$Genotype_2UMI =="MUT" | celltype[[i]]$Genotype_2UMI =="WT"),]
    mydf4$orig.ident
    library(lme4)
    form1 <- lmer(formula = mydf4[,j] ~ (1|orig.ident) + Genotype_2UMI, data = mydf4, REML = F)
    form2 <- lmer(formula = mydf4[,j] ~ (1|orig.ident), data = mydf4, REML = F)
    res <- anova(form1,form2)
    pval[[i]] <- format(res$`Pr(>Chisq)`[2], scientific=T,digits=3 )
    #print(pval)
  }
  df[[j]] <- as.data.frame(pval)
  colnames(df[[j]]) = c("NP", "IMP", "HSPC", "MkP", "MEP", "EP")
  final_df <- do.call(rbind, df)
}

temp <- as.data.frame(lapply(final_df, as.numeric))
rownames(temp) <- rownames(final_df)
LMM_pval_table <- temp
save(LMM_pval_table, file = "/Users/Celine/Documents/Landau/CITE-seq/2_MDS_patients/mds.p4.p5.p6.CITE.Analysis/LMM_pval_table_v3.Rdata")#write new path here
```


##-----------------------PART 3: Make heatmaps with logFC = color and ADTexp = point size-----------------------

##Make heatmaps
```{r}
#Load LMM adjusted p val table
LMM_pval_table
#Check the tables
ct_LogFC_tables
ct_p_val_tables
prot_exp_matrix
rna_exp_matrix
rna_exp_matrix <- as.data.frame(sapply(rna_exp_matrix, as.numeric)) 
rownames(rna_exp_matrix) <- c("CD99", "CD47", "CD84", "CD38", "PTPRC", "CD36", "TFRC","ITGA6")
prot_exp_matrix <- as.data.frame(sapply(prot_exp_matrix, as.numeric)) 
rownames(prot_exp_matrix) <-c("CD99","CD47","CD84","CD38","CD45","CD36","CD71","CD49f")
```

##Make a heatmap with color = logFC and circle size = RNA exp
```{r}
#First we need to make all the IDs the same and set Antibody as a separate column
rownames(ct_LogFC_tables) <-c("CD99","CD47","CD84","CD38","CD45","CD36","CD71","CD49f")
mod_df_logFC <- setNames(cbind(rownames(ct_LogFC_tables), ct_LogFC_tables, row.names = NULL), 
         c("Antibody", "NP", "IMP", "HSPC", "MkP", "MEP", "EP"))
rownames(prot_exp_matrix) <-c("CD99","CD47","CD84","CD38","CD45","CD36","CD71","CD49f")
mod_df_prot <- setNames(cbind(rownames(prot_exp_matrix), prot_exp_matrix, row.names = NULL), 
         c("Antibody","NP", "IMP", "HSPC", "MkP", "MEP", "EP"))
rownames(ct_p_val_tables) <-c("CD99","CD47","CD84","CD38","CD45","CD36","CD71","CD49f")
mod_pval <- setNames(cbind(rownames(ct_p_val_tables), ct_p_val_tables, row.names = NULL), 
         c("Antibody", "NP", "IMP", "HSPC", "MkP", "MEP", "EP"))
rownames(rna_exp_matrix)<-c("CD99","CD47","CD84","CD38","CD45","CD36","CD71","CD49f")
mod_rna <- setNames(cbind(rownames(rna_exp_matrix), rna_exp_matrix, row.names = NULL), 
         c("Antibody","NP", "IMP", "HSPC", "MkP", "MEP", "EP"))
```


```{r}
#Let's normalize each row by celltype
max <- rowMaxs(as.matrix(mod_df_prot[,-1]))
#value/Max normalization, across cell type for each AB
norm_df <- mod_df_prot[,-1] / max
norm_df$Antibody <- mod_df_prot$Antibody

#Melt dataframes
library(reshape2)
logFC <- melt(mod_df_logFC)
pval <- melt(mod_pval)
ADT_exp <- melt(mod_df_prot)
RNA_exp <- melt(mod_rna)
ADT_exp_norm <- melt(norm_df)
colnames(logFC) <- c("Antibody", "cell_assign", "logFC")
colnames(pval) <- c("Antibody", "cell_assign", "pval")
colnames(RNA_exp)<- c("Antibody", "cell_assign", "RNA_exp")
colnames(ADT_exp)<- c("Antibody", "cell_assign", "ADT_exp")
colnames(ADT_exp_norm)<- c("Antibody", "cell_assign", "ADT_exp_norm")
#Merge the dataframes. first we need the gene and antibody names to match. 
combined_df <- merge(logFC, ADT_exp_norm, by=c("Antibody","cell_assign")) 
combined_df <- merge(combined_df, RNA_exp, by=c("Antibody","cell_assign")) 
combined_df <- merge(combined_df, pval, by=c("Antibody","cell_assign")) 

```

```{r}
library(ggplot2)
#Supp figure: all antibodies
#Try to make dot size = ADT expression and color = logFC
ggplot(combined_df, aes(x= factor(cell_assign), y = factor(Antibody)))+
  geom_tile(fill = "white", color = "black")+
  geom_point(aes(color = logFC, size = ADT_exp_norm))+
  scale_colour_gradient2(low = "blue", mid = "cornsilk",
  high = "red3", midpoint = 0, space = "rgb",
  na.value = "grey50", guide = "colourbar")+
  scale_size_continuous(range = c(1,15)) + 
  xlab("Celltype")+
  ylab("Antibody")+
  theme_classic()

#Main figure panel: subset antibodies
#keep CD71, CD36, CD47, CD84
combined_df
main_df <- filter(combined_df, Antibody == "CD71"|Antibody == "CD36"|Antibody=="CD47"|Antibody=="CD84"|Antibody =="CD45")
ggplot(main_df, aes(x= factor(cell_assign), y = factor(Antibody)))+
  geom_tile(fill = "white", color = "black")+
  geom_point(aes(color = logFC, size = ADT_exp_norm))+
  scale_colour_gradient2(low = "blue", mid = "cornsilk",
  high = "red3", midpoint = 0, space = "rgb",
  na.value = "grey50", guide = "colourbar")+
  scale_size_continuous(range = c(1,15)) + 
  xlab("Celltype")+
  ylab("Antibody")+
  theme_classic()

```
Make color = -log10(p-value) x direction of change…
```{r}
#Assign a positive or negative for logFC. positive = higher [mut/wt]. negtaive = higher[wt/mut]
for(row in 1:nrow(combined_df)){
if(combined_df$logFC[[row]] > 0){
  combined_df$sign[[row]] <- 1
} else {
  combined_df$sign[[row]] <- -1
}
}
combined_df$sign <- unlist(combined_df$sign)

#Mutate to create a new column for the log10(pval)
combined_df <- mutate(combined_df, log10pval = sign * -log10(pval))
ggplot(combined_df, aes(x= factor(cell_assign), y = factor(Antibody)))+
  geom_tile(fill = "white", color = "black")+
  geom_point(aes(color = log10pval, size = ADT_exp_norm))+
  scale_colour_gradient2(low = "blue", mid = "cornsilk",
  high = "red3", midpoint = 0, space = "rgb",
  na.value = "grey50", guide = "colourbar")+
  scale_size_continuous(range = c(1,15)) + 
  xlab("Celltype")+
  ylab("Antibody")+
  theme_classic()
```


##----------------------PART 3: ITERATIVE DOWNSAMPLING WITH PERMUTATION TEST----------------------
##Iterative downsampling
Subset the ADT matrix instead of subsetting the whole Seurat object
```{r}
seurat <- mds.samples.integrated
patient_id <- "orig.ident"
geno_col <- "Genotype_2UMI"
cell_name <- "cell_name"
seurat@meta.data$cell_name <- rownames(seurat@meta.data) 
iterative_downsampled <- list()
metadata_downsampled <- list()
mut_cells <- list()
wt_cells <- list()
iteration_wt <- list()
iteration_mut <- list()
min_mut <- min(table(seurat@meta.data[,patient_id], seurat@meta.data[,geno_col])[,"MUT"])
min_wt <- min(table(seurat@meta.data[,patient_id], seurat@meta.data[,geno_col])[,"WT"])
celltypes <- unique(seurat@meta.data$Cell.Assignment_adj)

for(i in 1:1000){
  set.seed(i)
  mut_cells[[i]] <- seurat@meta.data %>% dplyr::select (c(patient_id, geno_col, cell_name)) %>% filter(!!as.symbol(geno_col) == "MUT") %>% group_by(!!as.symbol(patient_id)) %>% sample_n(min_mut, replace = F) %>% pull(cell_name)
  wt_cells[[i]] <- seurat@meta.data %>% dplyr::select (c(patient_id, geno_col, cell_name)) %>% filter(!!as.symbol(geno_col) == "WT") %>% group_by(!!as.symbol(patient_id)) %>% sample_n(min_wt, replace = F) %>% pull(cell_name)
  cells <- c(mut_cells[[i]], wt_cells[[i]])
  #print(length(cells))
  iterative_downsampled[[i]] <- seurat@assays$ADT@data[,cells]
  metadata_downsampled[[i]] <- seurat@meta.data[cells,]
  #print(iterative_downsampled[[i]])
  #print(mut_cells[[i]][1:10])
  #print(wt_cells[[i]][1:10])
  median_wt <- list()
  median_mut <- list()
  for(j in celltypes) {
    wt <- rownames(metadata_downsampled[[i]][which(metadata_downsampled[[i]]$Genotype_2UMI == "WT" & metadata_downsampled[[i]]$Cell.Assignment_adj == j),])
    mut <- rownames(metadata_downsampled[[i]][which(metadata_downsampled[[i]]$Genotype_2UMI == "MUT" & metadata_downsampled[[i]]$Cell.Assignment_adj == j),])
    median_wt[[j]] <- rowMedians(iterative_downsampled[[i]][,wt])
    median_mut[[j]] <- rowMedians(iterative_downsampled[[i]][,mut])
  }
  iteration_wt[[i]] <- median_wt
  iteration_mut[[i]] <- median_mut
}

#Make matrix of counts for WT 
df_wt = lapply(iteration_wt, function(x){
  do.call(rbind,x)
})
antibodies <- rownames(seurat@assays$ADT@data)

#Takes the mean across 1000 iterations for WT to generate a single matrix of means
mean_iteration_wt <- apply(simplify2array(df_wt), 1:2, mean)
colnames(mean_iteration_wt) <- antibodies

#Make matrix of counts for MUT
df_mut = lapply(iteration_mut, function(x){
  do.call(rbind,x)
})

#Takes the mean across 1000 iterations for MUT to generate a single matrix of means
antibodies <- rownames(seurat@assays$ADT@data)
mean_iteration_mut <- apply(simplify2array(df_mut), 1:2, mean)
colnames(mean_iteration_mut) <- antibodies

#Check to see how many WT and MUT cells are in one iteration of downsampled data
table(metadata_downsampled[[1]]$Genotype_2UMI)

#Calculate the median_logFC using the modified Find_Markers() function. logFC(MUT/WT) = log(MUT) - log(WT)
pseudocount.use <- 1
data.1 <- apply(X = mean_iteration_mut, MARGIN = c(1,2), FUN = function(x) log(x = median(x = expm1(x = x), na.rm = TRUE) + pseudocount.use))
data.2 <- apply(X = mean_iteration_wt, MARGIN = c(1,2), FUN = function(x) log(x = median(x = expm1(x = x), na.rm = TRUE) + pseudocount.use))
total.diff <- (data.1 - data.2)
logFC_df <- as.data.frame(total.diff)

#Reorder and change the col names before merging the logFC and ADT_exp_norm dataframes
logFC_df <- cbind(celltype = rownames(logFC_df), logFC_df)
logFC_df <- subset(logFC_df, select=c("celltype","ADT-CD99","ADT-CD47","ADT-CD84","ADT-CD38","ADT-CD45","ADT-CD36","ADT-CD71","ADT-CD49f"))
colnames(logFC_df) <- c("celltype","CD99","CD47","CD84","CD38","CD45","CD36","CD71","CD49f")
melted_df <- melt(logFC_df)
colnames(melted_df) <- c("celltype","antibody","logFC")
colnames(ADT_exp_norm) <- c("antibody","celltype","ADT_exp")
combined_df <- merge(melted_df, ADT_exp_norm, by = c("celltype","antibody"))

#Reorder the factor levels so that they show up in the right order on the heatmap
combined_df$celltype <- factor(combined_df$celltype, levels=c("NP", "IMP", "HSPC", "MkP", "MEP", "EP"))
combined_df$antibody <- factor(combined_df$antibody, levels = c("CD36","CD38","CD45","CD47","CD49f","CD71","CD84","CD99"))
```
Plot heatmap using iterative downsampling (1000x)
```{r fig.height=6,fig.width=6}
library(ggplot2)
ggplot(combined_df, aes(x= factor(celltype), y = factor(antibody)))+
  geom_tile(fill = "white", color = "black")+
  geom_point(aes(color = logFC, size = ADT_exp))+
  scale_colour_gradient2(low = "blue", mid = "cornsilk",
  high = "red3", midpoint = 0, space = "rgb",
  na.value = "grey50", guide = "colourbar")+
  scale_size_continuous(range = c(1,15)) + 
  xlab("Celltype")+
  ylab("Antibody")+
  theme_classic()
```

##Permutation test
```{r}
library(parallel)
md <- metadata_downsampled[[1]]
str(iterative_downsampled[[1]])
bycelltype <- list()
result <- list()
antibodies <- c("ADT.CD47","ADT.CD99","ADT.CD38","ADT.CD84","ADT.CD36","ADT.CD45","ADT.CD49f","ADT.CD71")
for(i in celltypes){
  bycelltype[[i]] <- md %>% filter(Cell.Assignment_adj == i)
  
  temp <- bycelltype[[i]][,antibodies]
  temp_wt <- colMedians(as.matrix(temp[bycelltype[[i]]$Genotype_2UMI == "WT",]))
  names(temp_wt) <- antibodies
  temp_mut <- colMedians(as.matrix(temp[bycelltype[[i]]$Genotype_2UMI == "MUT",]))
  names(temp_mut) <- antibodies
  observed <- log(temp_mut+1) - log(temp_wt+1)
  
  result[[i]] <- mclapply(1:10000, function(x){
    set.seed(x)
    samp <- sample(bycelltype[[i]]$Genotype_2UMI,size = nrow(bycelltype[[i]]), replace = F) #changes the order in the vector
    temp <- bycelltype[[i]][,antibodies]
    temp_wt <- colMedians(as.matrix(temp[samp == "WT",]))
    names(temp_wt) <- antibodies
    temp_mut <- colMedians(as.matrix(temp[samp == "MUT",]))
    names(temp_mut) <- antibodies
    shuffled <- log(temp_mut+1) - log(temp_wt+1)
    tf <- abs(observed)>abs(shuffled)
    return(tf)
  ##abs(observed)>abs(shuffled)? and store true false vector  
  }, mc.cores = 6)
}


temp <- lapply(result, function(x){
  as.data.frame(do.call(rbind,x))
})
pval <- lapply(temp, function(x){
  colSums(x == F)/10000
})

#Save the pval table, add significance in AI
save(pval,file="/Users/Celine/Documents/Landau/CITE-seq/2_MDS_patients/mds.p4.p5.p6.CITE.Analysis/permutation_test_pval") #change path here
```



##-------------------------PART 4: Ridgeplots and boxplots--------------------------------
##Ridgeplots
```{r fig.height=20, fig.width=10}
##Ridgeplot
antibodies <- rownames(mds.samples.integrated@assays$ADT@counts)
RidgePlot(mds.samples.integrated, features = antibodies, sort=T, assay="ADT")
```

##Boxplots comparing MUT v WT in ADT
```{r fig.width=12, fig.height=12}
#Subset by patient ident
Idents(mds.samples.integrated) <- "orig.ident"
p5_1 <- subset(mds.samples.integrated@meta.data, subset = orig.ident == "MDS_P5_1")
p5_2 <- subset(mds.samples.integrated@meta.data, subset = orig.ident == "MDS_P5_2")
p6 <- subset(mds.samples.integrated@meta.data, subset = orig.ident == "MDS_P6")
CurrObj <- mds.samples.integrated
#Run through each patient here individually
  CurrObj <- p5_1
  #CurrObj <- p5_2
  #CurrObj <- p6

##Make boxplot for ADT expression
features.list <- c("ADT.CD99","ADT.CD47","ADT.CD84","ADT.CD38","ADT.CD45","ADT.CD36","ADT.CD71","ADT.CD49f")
plot.list <- list()
for(i in features.list){
  feature <- i
  require(ggpubr)
  genotype <- "Genotype_2UMI"
  xvar <- "Cell.Assignment_adj"
  ct_list <- c("HSPC","IMP","NP","MkP","MEP","EP")
  plot.list[[i]] <- ggplot(CurrObj[which((CurrObj[[genotype]] == "MUT" | CurrObj[[genotype]] == "WT") & (CurrObj$Cell.Assignment_adj %in% ct_list) ),], aes_string(x = xvar, y = feature, fill = genotype)) + 
  geom_boxplot() + 
  labs(title = feature) +
  stat_compare_means(method = "wilcox.test", label = "p.signif", hide.ns = TRUE) + 
  scale_fill_manual(values = c("royalblue1", "firebrick2"),
                      breaks = c("WT", "MUT")) + 
  theme_classic()
}
cowplot::plot_grid(plotlist = plot.list, ncol = 3)
```

##Boxplots comparing MUT v WT in RNA
```{r fig.width=12, fig.height=12}
##Make boxplot for RNA expression
features.list <- c("CD99", "CD47", "CD84", "CD38", "PTPRC", "CD36", "TFRC", "ITGA6")
plot.list <- list()
for(i in features.list){
  feature <- i
  require(ggpubr)
  genotype <- "Genotype_2UMI"
  xvar <- "Cell.Assignment_adj"
  ct_list <- c("HSPC","IMP","NP","MkP","MEP","EP")
  plot.list[[i]] <- ggplot(CurrObj[which((CurrObj[[genotype]] == "MUT" | CurrObj[[genotype]] == "WT") & (CurrObj$Cell.Assignment_adj %in% ct_list) ),], aes_string(x = xvar, y = feature, fill = genotype)) + 
  geom_boxplot() + 
  labs(title = feature) +
  stat_compare_means(method = "wilcox.test", label = "p.signif", hide.ns = TRUE) + 
  scale_fill_manual(values = c("royalblue1", "firebrick2"),
                      breaks = c("WT", "MUT")) + 
  theme_classic()
}
cowplot::plot_grid(plotlist = plot.list, ncol = 3)

```


##--------------------PART 5: ADT v. RNA Corrplots grouped by celltype----------------------
Cluster by celltype, then plot mean_ADT_exp and mean_ADT_exp per each cluster, run Spearman's correlation 
```{r fig.width=10, fig.height=10}
##Let's combine ADT and RNA expression df's then plot the mean of each as a corrplot
adt_rna <- merge(RNA_exp, ADT_exp, by=c("Antibody","cell_assign")) 
colnames(adt_rna) <- c("Antibody","variable","RNA_exp","ADT_exp")
antibodies <- unique(adt_rna$Antibody)
plots <- list()
subsetted <- list()
for(i in antibodies){
  subsetted[[i]] <- subset(adt_rna, Antibody == i)
  plots[[i]] <- ggscatter(subsetted[[i]], x="ADT_exp", y="RNA_exp", add = "reg.line",
   add.params = list(color = "blue", fill = "lightgray"), 
   conf.int = TRUE, 
   cor.coef = TRUE,
   cor.method = "spearman")+ 
    theme_classic()+
    stat_cor(method = "spearman", aes(label = ..r.label..))+
    ggtitle(i)
  }
clustered_corr <- cowplot::plot_grid(plotlist = plots, ncol = 3)
print(clustered_corr)
```


```{r fig.width=12, fig.height=10}
##Let's add in celltype as an aes layer
antibodies <- unique(adt_rna$Antibody)
plots <- list()
subsetted <- list()
for(i in antibodies){
  subsetted[[i]] <- subset(adt_rna, Antibody == i)
  plots[[i]] <-  ggplot(subsetted[[i]], aes(x=ADT_exp, y=RNA_exp)) + 
    geom_point(aes(color=variable))+
    geom_smooth(method=lm, se = FALSE)+
    theme_classic()+
    stat_cor(method = "pearson")+
    ggtitle(i)
}
clustered_corr <- cowplot::plot_grid(plotlist = plots, ncol = 3)
print(clustered_corr)

```



